import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { UserPurchaseHistory } from './entities/user-purchase-history.entity';
import { Repository } from 'typeorm';
import { Order, OrderItem } from 'src/config/entities.config';
import { endOfDay, startOfDay } from 'date-fns';
import { OrderStatus } from 'src/modules/order/enums/order-status.enum';
import { Between } from 'typeorm';
import { differenceInDays, differenceInMonths } from 'date-fns';

process.env.TZ = 'Asia/Bangkok';

@Injectable()
export class AnalyticsService {
  constructor(
    @InjectRepository(UserPurchaseHistory)
    private readonly purchaseRepo: Repository<UserPurchaseHistory>,
    @InjectRepository(OrderItem)
    private readonly orderItemRepo: Repository<OrderItem>,
    @InjectRepository(Order)
    private readonly orderRepo: Repository<Order>,
  ) {}

  async showPurchaseHistory() {
    const purchase = await this.purchaseRepo.find();
    console.log(purchase.length);
    return purchase;
  }

  async getSalesSummary(
    from: string,
    to?: string,
  ): Promise<{
    range: { from: string; to: string };
    sales_summary: number;
    average_per_month: number;
    total_order: number;
    charts: Record<string, string | number>[];
  }> {
    const start = startOfDay(new Date(from));
    const end = to ? endOfDay(new Date(to)) : endOfDay(new Date(from));

    const items = await this.orderItemRepo.find({
      select: {
        order: {
          order_date: true,
        },
      },
      where: {
        order: {
          status: OrderStatus.PAID,
          order_date: Between(start, end),
        },
      },
      relations: { variant: true, order: true },
    });

    const total_order = await this.orderRepo.count({
      where: {
        status: OrderStatus.PAID,
        order_date: Between(start, end),
      },
    });

    const summary = items.reduce(
      (acc, { total_price }) => {
        acc.sales_summary += Number(total_price);
        return acc;
      },
      { sales_summary: 0, average_per_month: 0 },
    );

    const diffDays = differenceInDays(end, start) || 1;
    summary.average_per_month = Number(
      (summary.sales_summary / diffDays).toFixed(2),
    );

    return {
      range: {
        from: start.toString().split('T')[0],
        to: end.toString().split('T')[0],
      },
      sales_summary: summary.sales_summary,
      average_per_month: summary.average_per_month,
      total_order,
      charts: items.map((item) => ({
        date: item.order.order_date.toISOString().split('t')[0],
        sales: Number(item.total_price),
      })),
    };
  }

  async getPaidOrder(): Promise<Order[]> {
    return await this.orderRepo.findBy({ status: OrderStatus.PAID });
  }
}
